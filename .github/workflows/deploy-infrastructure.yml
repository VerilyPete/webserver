# .github/workflows/deploy-infrastructure.yml
name: Deploy Web Infrastructure

on:
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'update'
        type: choice
        options:
          - update
          - fresh_deploy
      hostname:
        description: 'Custom hostname (optional)'
        required: false
        type: string

  push:
    branches: [main]
    paths:
      - 'compose.yml'
      - '.github/workflows/deploy-infrastructure.yml'

env:
  OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
  OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
  OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
  OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}
  OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate unique hostname
        id: hostname
        run: |
          if [ -n "${{ github.event.inputs.hostname }}" ]; then
            echo "hostname=${{ github.event.inputs.hostname }}" >> $GITHUB_OUTPUT
          else
            echo "hostname=web-server-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      - name: Deploy new instance (fresh deploy)
        if: github.event.inputs.deploy_type == 'fresh_deploy' || github.event_name == 'workflow_dispatch'
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        id: create_instance
        with:
          command: 'compute instance launch --availability-domain "${{ secrets.OCI_AVAILABILITY_DOMAIN }}" --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" --shape "VM.Standard.A1.Flex" --shape-config "{\"memoryInGBs\":6,\"ocpus\":1}" --image-id "${{ secrets.OCI_IMAGE_ID }}" --subnet-id "${{ secrets.OCI_SUBNET_ID }}" --user-data-file fixed_podman_cloud_init.yml --display-name "${{ steps.hostname.outputs.hostname }}" --metadata "{\"TAILSCALE_AUTH_KEY\":\"${{ secrets.TAILSCALE_AUTH_KEY }}\",\"CLOUDFLARE_TUNNEL_TOKEN\":\"${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}\",\"FORMSPREE_ENDPOINT\":\"${{ secrets.FORMSPREE_ENDPOINT }}\",\"HOSTNAME\":\"${{ steps.hostname.outputs.hostname }}\"}" --wait-for-state RUNNING --max-wait-seconds 300'

      - name: Find existing instance (update)
        if: github.event.inputs.deploy_type == 'update' || github.event_name == 'push'
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        id: find_instance
        with:
          command: 'compute instance list --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" --lifecycle-state RUNNING'
          query: "data[?contains(\"display-name\", 'web-server')].id | [0]"

      - name: Get instance IP and update (update)
        if: github.event.inputs.deploy_type == 'update' || github.event_name == 'push'
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        id: get_instance_ip
        with:
          command: 'compute instance list-vnics --instance-id "${{ steps.find_instance.outputs.output }}"'
          query: "data[0].\"public-ip\""

      - name: Update existing infrastructure
        if: (github.event.inputs.deploy_type == 'update' || github.event_name == 'push') && steps.find_instance.outputs.output != 'null' && steps.find_instance.outputs.output != ''
        run: |
          PUBLIC_IP="${{ steps.get_instance_ip.outputs.output }}"
          PUBLIC_IP=$(echo $PUBLIC_IP | tr -d '"')
          
          echo "Found instance with IP: $PUBLIC_IP"
          
          # Wait for SSH to be available
          echo "Waiting for SSH access..."
          for i in {1..30}; do
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no opc@$PUBLIC_IP "echo 'SSH Ready'" 2>/dev/null; then
              echo "SSH connection successful"
              break
            fi
            echo "Attempt $i/30 failed, waiting 10 seconds..."
            sleep 10
          done
          
          # Update the running infrastructure
          ssh -o StrictHostKeyChecking=no opc@$PUBLIC_IP << 'EOF'
            cd ~/web-infra
            git pull origin main
            
            # Update environment with latest secrets
            export TAILSCALE_AUTH_KEY="${{ secrets.TAILSCALE_AUTH_KEY }}"
            export CLOUDFLARE_TUNNEL_TOKEN="${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}"
            export FORMSPREE_ENDPOINT="${{ secrets.FORMSPREE_ENDPOINT }}"
            sudo /usr/local/bin/create-env-from-metadata.sh
            
            # Restart services
            systemctl --user restart web-infra-pod.service
            
            # Wait a moment and check status
            sleep 5
            systemctl --user status web-infra-pod.service
            podman pod ps
          EOF

      - name: Handle no existing instance
        if: (github.event.inputs.deploy_type == 'update' || github.event_name == 'push') && (steps.find_instance.outputs.output == 'null' || steps.find_instance.outputs.output == '')
        run: |
          echo "âŒ No running instance found with 'web-server' in the name"
          echo "ðŸ’¡ Use 'fresh_deploy' to create a new instance"
          exit 1

      - name: Display new instance info (fresh deploy)
        if: github.event.inputs.deploy_type == 'fresh_deploy' || github.event_name == 'workflow_dispatch'
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: 'compute instance get --instance-id "${{ fromJson(steps.create_instance.outputs.output).data.id }}"'
          query: "data.{id: id, name: \"display-name\", state: \"lifecycle-state\", shape: shape, region: region}"

      - name: Get new instance IP (fresh deploy)
        if: github.event.inputs.deploy_type == 'fresh_deploy' || github.event_name == 'workflow_dispatch'
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        id: get_new_ip
        with:
          command: 'compute instance list-vnics --instance-id "${{ fromJson(steps.create_instance.outputs.output).data.id }}"'
          query: "data[0].\"public-ip\""

      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed successfully!"
          echo ""
          if [ "${{ github.event.inputs.deploy_type }}" = "fresh_deploy" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ðŸ†• New instance created:"
            echo "   Instance ID: ${{ fromJson(steps.create_instance.outputs.output).data.id }}"
            echo "   Public IP: ${{ steps.get_new_ip.outputs.output }}"
            echo "   Hostname: ${{ steps.hostname.outputs.hostname }}"
          else
            echo "ðŸ”„ Existing instance updated:"
            echo "   Instance ID: ${{ steps.find_instance.outputs.output }}"
            echo "   Public IP: ${{ steps.get_instance_ip.outputs.output }}"
          fi
          echo ""
          echo "ðŸ” Check your Tailscale admin console for the device"
          echo "ðŸŒ Web server will be accessible at http://[tailscale-ip]:8081"
          echo "ðŸ“Š Monitor with: ssh opc@[instance-ip] 'podman pod ps'"

  cleanup-old-instances:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.deploy_type == 'fresh_deploy'
    
    env:
      OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}
      OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}
    
    steps:
      - name: List old instances for manual cleanup
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: 'compute instance list --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" --lifecycle-state RUNNING'
          query: "data[?contains(\"display-name\", 'web-server')].{Name:\"display-name\", ID:id, Created:\"time-created\"}"
          silent: false

      - name: Cleanup instructions
        run: |
          echo ""
          echo "ðŸ§¹ Old instances listed above may need cleanup"
          echo "ðŸ’¡ To terminate old instances:"
          echo "   Use the OCI Console or run:"
          echo "   oci compute instance terminate --instance-id <INSTANCE_ID> --force"